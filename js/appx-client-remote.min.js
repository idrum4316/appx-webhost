/*********************************************************************
 **
 **   public/js/appx-client-remote.js - Client Remote conenction code
 **
 **   This module handles the connection and data traffic between the
 **   Appx Client running in the browser and the appx connector code
 **   running on the server.  The server connector is our proxy into
 **   the server Appx application.
 **
 *********************************************************************/
function APPX(e,a,t,s,n,r,o){function i(e,a,t,s,n,r){function o(){var e={cmd:"ping",args:[0,0],handler:"",data:null}
p.send(JSON.stringify(e)),c=setTimeout(o,3e4)}var p
null!=a&&null!=t?"ssl"==s?(ws_url="wss://"+a+":"+t+n,$("#appxFooterSSL").show(),$("#appxLoginSSL").show()):ws_url="ws://"+a+":"+t+n:ws_url="ws://localhost:3014/",p=new WebSocket(ws_url),p.send=function(e){var a=e
return appx_session.crypto&&(a=CryptoJS.AES.encrypt(e,"APPX",{format:JsonFormatter})),WebSocket.prototype.send.call(this,a)},p.onmessage=function(a){var t=a.data
appx_session.crypto&&(t=CryptoJS.AES.decrypt(a.data,"APPX",{format:JsonFormatter}).toString(CryptoJS.enc.Utf8)),e.handler(a,t)}
var c
return p.onopen=function(e){APPX.access=!0,appx_access=!0,o(),$("#appx_access").html("Remote+").css({color:"lime","font-weight":"bold"}),$("#functions").toggleClass("functions_on"),initialize_appx_session(r)},p.onclose=function(e){if(clearTimeout(c),APPX.access=!1,appx_access=!1,$("#appx_access").html("Remote").css({color:"#F77","font-weight":"bold"}),$("#functions").toggleClass("functions_on"),appx_session.connected){var a=$("<span>").html("Lost connection to server").addClass("status-msg").addClass("status-msg-error")
$("#appx-status-msg").html(a)}},p.onerror=function(o){console.log(o),l.connectRetryCount>0&&(l.connectRetryCount--,l.ws=i(e,a,t,s,n,r))},p}function p(){function e(e,a){debug&&logactivity("main handler: "+e)
try{var t=JSON.parse(a)
switch(t.serverConnectorVersionStr&&(appx_session.serverConnectorVersionStr=t.serverConnectorVersionStr,appx_session.serverConnectorVersionNum=t.serverConnectorVersionNum),t.mongoStatus&&("Error"!==t.mongoStatus||appx_session.mongoErrorDisplayed||(console.log(mongoConnectError),alert(appx_session.language.alerts.mongoConnectError),appx_session.mongoErrorDisplayed=!0)),appx_session.serverInterrupt=!1,t.type){case"HTML":$("#appx-frame").append(t.data)
break
case"STYLE":inject_style(t.data)
break
case"UPDATE":appxupdatelocalhandler(t.data)
break
case"SCRIPT":inject_script(t.data)
break
case"APPXLOGIN":appxloginhandler(t),appx_session.loginTimeout=!1
break
case"APPXRECONNECT":appxreconnecthandler(t)
break
case"APPXINIT":appxinithandler(t)
break
case"APPXFEATURES":appxfeatureshandler(t)
break
case"APPXEXTENDEDFEATURES":appxextendedfeatureshandler(t)
break
case"APPXPID":appxpidhandler(t)
break
case"APPXATTACH":appxattachhandler(t),$(document).on("keydown",function(e){sendkey(e)}),$(document).on("keyup",function(e){sendkey(e)})
break
case"APPXKEYMAP":appxkeymaphandler(t)
break
case"APPXITEMS":appxitemshandler(t)
break
case"APPXMSGS":appxmsgshandler(t)
break
case"APPXWIDGETS":appxwidgetshandler(t)
break
case"APPXSHOW":appxshowhandler(t)
break
case"APPXSCREEN":appx_session.blur=!1,appxscreenhandler(t)
break
case"APPXATTRIBUTES":appxattributeshandler(t)
break
case"APPXEXTRAATTRIBUTES":appxextraattributeshandler(t)
break
case"APPXPING":appxpinghandler(t)
break
case"APPXTOKEN":appxtokenhandler(t)
break
case"APPXRESOURCE":AppxResource.handler(t)
break
case"APPXSETFIELD":appxsetfieldhandler(t)
break
case"APPXLOADURL":appxloadurlhandler(t)
break
case"APPXRECEIVEFILE":appxreceivefilehandler(t)
break
case"APPXFILEUPLOADPROGRESS":appxfileuploadprogresshandler(t)
break
case"APPXSENDFILE":appxsendfilehandler(t)
break
case"APPXMENU":appxmenuhandler(t)
break
case"APPXCREATEOBJECT":appxobjectcreatehandler(t)
break
case"APPXINVOKEOBJECT":appxobjectinvokehandler(t)
break
case"APPXDESTROYOBJECT":appxobjectdestroyhandler(t)
break
case"APPXFINISH":appxfinishhandler(t)
break
case"APPXCNSTS":appxconstantshandler(t)
break
case"APPXGETCLIPBOARD":appxgetclipboardhandler(t)
break
case"APPXSETCLIPBOARD":appxsetclipboardhandler(t)
break
case"APPXTABLEDATA":appxtabledatahandler(t)
break
case"APPXQUERYTABLEDATA":appxupdatetabledatahandler(t)
break
case"APPXENCODINGERROR":appxEncodingError(t.data[1])
case"APPXPROCSTACK":appxProcessStack(t.data)
default:logactivity("No handler for APPX Data Message:  "+a)}}catch(s){logactivity(s),console.log("REMOTE Handler: "+s),console.log(s.stack)}}this.handler=e}var l=this
switch(this.connectRetryCount=2,this.message=new p,this.ws=i(this.message,e,a,n,s,o),this.appxDataCacheUrl=appxProtocol+"://"+appxConnectorHost+":"+appxConnectorMongoPort+appxConnectorPathHttp+"/getGridData",this.appxCacheUrl=appxProtocol+"://"+appxConnectorHost+":"+appxConnectorMongoPort+appxConnectorPathHttp,this.appxResourceUrl=appxProtocol+"://"+appxConnectorHost+":"+appxConnectorMongoPort+appxConnectorPathHttp+"/getResource/",this.current_msg={header:[]},this.uploadURL=null,this.userPrefsURL=null,this.init_optimization_flag=null,this.override=!1,this.blur=!1,this.current_show=null,this.clientIds={},this.editorConfigs={},this.widgets=[],this.appxTableList={},this.currenttabledata=[],this.items=[],this.rowtext=[],this.lineSeparator,this.basefontsize=r,this.rowHeightPx=21,this.colWidthPx=8,this.processhelp=!1,this.processhelpoption=null,this.runOnUnlock=[],this.scan=!1,this.screenrows=35,this.screencols=144,this.container_top=80,this.language={},this.image_cache={keys:[],length:0},this.token_cache={keys:[],length:0},this.token_groups={},this.showErrorDialog=null,this.pid=0,this.currsendfile={filename:"",filedata:[]},this.datacachepath="",this.loginTimeout=!0,this.serverConnectorVersionStr,this.serverConnectorVersionNum,this.localConnectorRunning=!1,this.localInstaller=null,this.mongoErrorDisplayed=!1,this.server=e,this.port=a,this.mongoPort=t,this.user=null,this.password=null,this.path=s,this.protocol=n,this.crypto="aes"==n,this.currentmenu=null,this.showoptnums=!1,this.createWidgetTag={},this.optionOverride={},this.globals={},this.gridcache={},this.gridpropscache={},this.dndData=[],this.connected=!1,this.interactT=null,this.interactTblur=null,this.topboxid=null,this.objFocus=null,this.objEventFired=!1,this.objItems=null,this.signaturePad,this.signaturePadID,this.signaturePadFail=!0,this.serverInterrupt=!1,this.activeDatepicker=null,this.locked=!1,this.keyLeft=null,this.msgs=[],this.dirtySinceSave=!1,this.tablist=null,this.lastOption,this.keyPauseLastPosition,this.rawEncoding,this.buildingEm=!1,this.config={debug:{tableLogging:!0}},this.rowCallback=!1,this.pendingResources={length:0},this.pendingTables=0,this.tableOptions,this.tableLoaded=!0,this.tablePreferences={},this.tableDefaults={},this.fileRecommendedUploadSize=parseInt($("meta[name=appx-recommended-upload-size]").attr("content")),this.fileCount=0,this.mongoFileUpload=[],this.mongoURL="",this.dropEvent=null,this.filesUploadArray=[],this.centerHorizontalOffset=76,this.centerVerticalOffset=0,this.valueTimer=null,this.valueTimerStart=function(e,a){if(appx_session.valueTimerStop(),e&&e!=OPT_NULL){var t=parseInt(appx_session.getProp("valueChangedTimer"))
t>0&&(logca("setting timeout"),appx_session.valueTimer=setTimeout(function(e){appx_session.valueTimer?(appx_session.valueTimerStop(),appx_session.keyPauseLastPosition=getCursorPosition(a),logca("keyPause: "+e),appxIsLocked()?logca("(locked"):appxwidgetcallback(e)):logca("keyPause was cancelled")},t,e))}},this.valueTimerStop=function(){appx_session.valueTimer&&(clearTimeout(appx_session.valueTimer),appx_session.valueTimer=null,logca("valueTimer stopped"))},this.globals.os=window.navigator.platform,this.globals.os){case"Win32":case"Win64":this.localInstaller="localConnector_win.exe",this.lineSeparator="\r \n"
break
case"MacIntel":this.localInstaller="localConnector_osx.dmg",this.lineSeparator="\n"
break
case"Linux x86_64":this.localInstaller="localConnector_linux64.sh",this.lineSeparator="\n"
break
case"Linux i686":this.localInstaller="localConnector_linux32.sh",this.lineSeparator="\n"
break
default:this.localInstaller="System Unknown",this.lineSeparator="\r \n"}var c=3621123835
mask0=(4278190080&c)>>24,mask1=(16711680&c)>>16,mask2=(65280&c)>>8,mask3=255&c,this.feature_mask=[parseInt(mask0),parseInt(mask1),parseInt(mask2),parseInt(mask3)]
var h=14331
exmask0=(4278190080&h)>>24,exmask1=(16711680&h)>>16,exmask2=(65280&h)>>8,exmask3=255&h,this.extended_feature_mask=[parseInt(exmask0),parseInt(exmask1),parseInt(exmask2),parseInt(exmask3)],$("<div id='appx_main_container_wrapper'>").addClass("appx_main_container_wrapper").append($("#appx_main_container")).appendTo("#main"),this.loginTimer=function(){setTimeout(function(){appx_session.loginTimeout&&(alert(appx_session.language.alerts.serverConnectError),location.reload())},1e4)}}function fetchQueryTableRowData(e,a,t,s){var n={cmd:"appxquerytabledata",args:[e,a],handler:"appxquerytabledata",data:null}
appx_session.ws.send(JSON.stringify(n))}function appxupdatetabledatahandler(e){updateGridMongo(e.data.rows,e.data.elid)}function appxProcessStack(e){for(var a in appx_session.gridpropscache){var t=!1
for(var s in e)a.indexOf(s)>-1&&(t=!0)
t||delete appx_session.gridpropscache[a]}}function fetchInitialTableRowData(e,a,t,s){var n={cmd:"appxtabledata",args:[e,a,t,s],handler:"appxtabledata",data:null}
appx_session.ws.send(JSON.stringify(n))}function appxtabledatahandler(e){var a=appx_session.currenttabledata[e.data.elid]
createGridMongo(a,e.data.rows,e.data.elid)}var cMsgCount=0,JsonFormatter={stringify:function(e){var a={ct:e.ciphertext.toString(CryptoJS.enc.Base64)}
return e.iv&&(a.iv=e.iv.toString()),e.salt&&(a.s=e.salt.toString()),JSON.stringify(a)},parse:function(e){var a=JSON.parse(e),t=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(a.ct)})
return a.iv&&(t.iv=CryptoJS.enc.Hex.parse(a.iv)),a.s&&(t.salt=CryptoJS.enc.Hex.parse(a.s)),t}}
