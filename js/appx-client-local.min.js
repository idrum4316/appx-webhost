/*********************************************************************
 **
 **   public/js/appx-client-local.js - Client Local connection code
 **
 **   This module handles the connection and data traffic between the
 **   Appx Client running in the browser and the appx connector code
 **   running on the desktop.  The local connector is our proxy into
 **   the desktop OS.
 **
 *********************************************************************/
function showLocalMissing(){var a="<h1>Local Desktop Access</h1><p>This application requires local access to your desktop to perform certain functions.  This is a one time activity that does not require any Administrator privileges.</p><p>To allow this access please perform the following steps:<ol><li>Click this link to download the local connector. (<a href='"+appxClientRoot+"/"+appx_session.localInstaller+"'>Download Local Connector</a>)</li><li>Run the downloaded file and follow the prompts.</li><li>Close this popup window to retry local desktop access.</li></p>",e=($("<div id='appx_prefs'>").css({background:"rgba(50, 50, 50, 0.7)",width:"100%",height:"100%","min-height":"220px","z-index":"10000000",display:"none",position:"absolute",top:"0px",left:"0px","font-family":"verdana","font-size":"11px"}).appendTo("body"),$("<div style='border: 10px solid #333;'>").css({width:"550px",height:"220px",background:"#fff"}).appendTo("#appx_prefs").position({my:"center",at:"center",of:window}).draggable()),o=$("<div>").css({margin:"0px 10px",width:"550px",height:"220px"}),l=$("<div>").css({background:"#333","text-align":"right",padding:"5px",color:"#F5F539","font-weight":"bold","padding-bottom":"10px"}).append($("<span>close(X)</span>").click(function(){$("#appx_prefs").hide(),$("#appx_prefs").remove(),localos_session=new LOCALOS}))
$(e).prepend($("<div>").append(l)),$(o).append($("<div>").append(a)),$(o).appendTo(e),$("#appx_prefs").show(),$(a).find("input").change(function(){appx_session.setProp($(this).attr("id"),$(this).val()),null!=appx_session.getRawProp($(this).attr("id"))?$(this).css({background:"#ff0"}):$(this).css({background:"#fff"})})}function LOCALOS(){function a(a){try{var e=new WebSocket("ws://127.0.0.1:3013/")
e.onmessage=function(e){debug&&(logactivity("svr message:  "),logactivity(e.data),appendMessage(e.data+"\n\n")),a.handler(e)},e.onopen=function(a){localos_access=!0,appx_session.localConnectorRunning=!0,$("#localos_access").removeClass().addClass("connected").html("<a href='"+appxClientRoot+"/"+appx_session.localInstaller+"'>Local+</a>"),appendMessage("* Connection to local server(localhost:3013)  open<br/>"),$("#functions").toggleClass("functions_on"),initialize_localos_session()},e.onclose=function(a){localos_access=!1,$("#localos_access").removeClass().addClass("disconnected").html("<a href='"+appxClientRoot+"/"+appx_session.localInstaller+"'>Local</a>"),"true"!=appxLocalRequired||localos_access||localos_session.isUpdating||navigator.userAgent.indexOf("Mobile")!==-1||(showLocalMissing(),appxLocalRequired=!1,appx_session.localConnectorRunning=!1),appendMessage("* Connection to local server(localhost:3013) closed<br/>"),$("#functions").toggleClass("functions_on")},e.onerror=function(a){appendMessage("* Local server(localhost:3013) Error<br/>")}}catch(o){alert(o),console.log(o.stack)}return e}function e(){function a(a){debug&&logactivity("main handler: "+a)
try{var e=JSON.parse(a.data)
switch(logactivity("data:  "+e.data),e.type){case"LOCALOS-RELOAD":setTimeout(function(){localos_session=new LOCALOS,localos_session.isUpdating=!1},500)
break
case"LOCALOS-DND":appx_session.dndData=e.data,appxwidgetcallback(OPT_DROP)
break
case"LOCALOS-HTML":$("#appx-frame").append(e.data)
break
case"LOCALOS-STYLE":localos_style_handler(e.data)
break
case"LOCALOS-SCRIPT":inject_script(e.data)
break
case"LOCALOS-OPENFILE":localos_file_handler(e)
break
case"LOCALOS-OPENIMAGE":localos_image_handler(e.data)
break
case"LOCALOS-RUNCOMMAND":localos_cmd_handler(e.data)
break
case"LOCALOS-EXECOMMAND":localos_exec_handler(e.data)
break
case"LOCALOS-ENVIRONMENT":localos_enviro_handler(e.data)
break
case"LOCALOS-SETCLIPBOARD":localos_setclipboard_handler(e.data)
break
case"LOCALOS-GETCLIPBOARD":localos_getclipboard_handler(e.data)
break
case"LOCALOS-FILE-DIALOG":localos_file_dialog_handler(e.data)
break
case"LOCALOS-ERROR":localos_error_handler(e)
break
case"LOCALOS-CREATEFILE":localos_create_file_handler(e.data)
break
case"LOCALOS-APPENDFILE":localos_append_file_handler(e.data)
break
default:logactivity("No handler for LOCAL OS Data Message:  "+a.data)}}catch(o){logactivity(o),console.log("LOCAL Handler: "+o),console.log(o.stack)}}this.handler=a}this.message=new e,this.ws=a(this.message),this.current_msg={header:[]},this.isUpdating=null}function localos_file_dialog_handler(a){var e=$(".awaiting_filepath")
$(e).removeClass("awaiting_filepath"),a&&a.length>0&&a[0].length>0&&($(e).val(a),$(e).addClass("dirty"))}function localos_setclipboard_handler(a){logactivity("localos_setclipboard_handler() called..."),console.log("clipboard data set in localos:  "+a)}function localos_getclipboard_handler(a){logactivity("localos_setclipboard_handler() called..."),console.log("clipboard data got in localos:  "+a)
var e=a,o={cmd:"appxclipboard",args:[e],handler:"appxsendfilehandler",data:null}
appx_session.ws.send(JSON.stringify(o))}function localos_exec_handler(a){logactivity("localos_exec_handler() called..."),console.log("an exec handler was called:  "),console.dir(a)}function localos_error_handler(a){if(logactivity("localos_error_handler() called..."),console.log("an error occurred on localos connector:  "),console.dir(a),"openfile"===a.cmd){var e={cmd:"appxmessage",args:[3,0],handler:"APPXRECEIVEFILE",data:null}
appx_session.ws.send(JSON.stringify(e))}}function localos_file_handler(a){appx_session.ws.send(JSON.stringify(a)),logactivity("localos_file_handler() called...")}